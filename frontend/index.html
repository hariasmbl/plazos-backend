<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consultor de RUT - BL Capital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    function normalizarRut(rut) {
      return rut.replace(/\./g, "").replace(/\s+/g, "").replace(/-k$/i, "-K").toUpperCase();
    }
  </script>
</head>

<body class="bg-white text-gray-800 font-sans">
  <header class="bg-blue-900 text-white shadow">
    <div class="max-w-6xl mx-auto flex justify-between items-center p-4">
      <img src="assets/logo.png" alt="BL Capital" class="h-10">
      <h1 class="text-xl font-semibold">Consultor de Plazos de Pago</h1>
    </div>
  </header>

  <main class="max-w-4xl mx-auto mt-10 p-4">
    <div id="authSection" class="text-center">
      <p class="text-lg mb-4">Accede con tu cuenta corporativa @blcapital.cl</p>
      <button id="loginBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Iniciar sesi√≥n con Google</button>
    </div>

    <div id="appContent" class="hidden">
      <div class="flex justify-end mb-4">
        <button id="logoutBtn" class="bg-gray-300 px-3 py-1 text-sm rounded hover:bg-gray-400">Cerrar sesi√≥n</button>
      </div>

      <form id="consultaForm" class="flex gap-4 mb-6">
        <input type="text" id="rut" placeholder="Ingrese RUT del deudor (Ejemplo: 12345678-9)" required class="border rounded px-4 py-2 flex-1">
        <button type="submit" class="bg-blue-700 text-white px-6 py-2 rounded hover:bg-blue-800">Consultar</button>
      </form>

      <!-- input oculto para factorDias (CAMBIO #1) -->
      <input type="hidden" id="factorDias" value="15">

      <div id="resultados" class="space-y-6"></div>

      <div class="mt-4">
        <button onclick="limpiarResultados()" class="text-sm text-gray-600 underline hover:text-gray-800">Limpiar resultados</button>
      </div>
    </div>
  </main>

  <footer class="bg-gray-100 text-center text-sm py-4 text-gray-600">
    &copy; 2025 BL Capital. Todos los derechos reservados.
  </footer>

  <!-- ========================================================== -->
  <!-- L√ìGICA DEL CONSULTOR -->
  <!-- ========================================================== -->
  <script>
    let simulacionAprobada = false;

    document.getElementById('consultaForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const rawRut = document.getElementById('rut').value.trim();
      const rut = normalizarRut(rawRut);

      const res = await fetch(`https://plazos-backend.onrender.com/consultar-rut?rut=${rut}`, {
        method: "GET",
        mode: "cors"
      });

      const data = await res.json();

      // üîπ CAMBIO #2 ‚Äî guardar factor que viene desde backend
      if ("factor_dias" in data) {
        document.getElementById("factorDias").value = data.factor_dias;
      }

      mostrarResultados(data);
    });

    function mostrarResultados(data) {
      const div = document.getElementById('resultados');
      div.innerHTML = '';

      if (data.error) {
        div.innerHTML = `<p class="text-red-600 font-semibold">${data.error}</p>`;
        return;
      }

      const f = formatFecha;
      const nombre = data.nombre_deudor || "Sin nombre";

      let html = `
        <h2 class="text-xl font-bold text-blue-800 mb-4">Deudor: ${nombre}</h2>
      `;

      if (data.riesgo_detectado) {
        html += `
          <section class="bg-yellow-100 border border-yellow-400 text-yellow-800 px-4 py-3 rounded mb-4">
            <p>Revisar el plazo y anticipo con RIESGO. Hay documentos morosos cuyo plazo desde la emisi√≥n supera lo recomendado (${data.plazo_recomendado} d√≠as).</p>
            <button onclick="window.print()" class="mt-2 bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700">
              Guardar como PDF
            </button>          
          </section>`;
      }

      if (!data.recomendacion.toLowerCase().includes("riesgo")) {

        // üîπ CAMBIO #3 ‚Äî pasar factorDias al bot√≥n del simulador
        html += `
          <section class="mt-6">
            <h2 class="text-lg font-semibold text-blue-800 mb-2">¬øDesea revisar plazo y anticipo?</h2>
            <div class="flex items-end gap-4 mb-4">
              <div>
                <label for="plazo" class="block text-sm font-medium">Plazo (d√≠as):</label>
                <input type="number" id="plazo" class="border px-2 py-1 w-24" min="1">
              </div>
              <div>
                <label for="anticipo" class="block text-sm font-medium">% Anticipo:</label>
                <input type="number" id="anticipo" class="border px-2 py-1 w-24" min="0" max="100">
              </div>

              <button onclick="simular(${data.plazo_recomendado}, ${data.factor_dias || 15})"
                class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                Simular
              </button>

              <button id="confirmarBtn" onclick="confirmarSimulacion()"
                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" disabled>
                Confirmar
              </button>
            </div>
            <div id="evaluacionResultado" class="mt-4 text-sm font-semibold"></div>
          </section>`;
      }

      // ==========================================================
      // RESTO DEL C√ìDIGO ‚Äî TABLAS, LISTADOS, TODO IGUAL
      // ==========================================================

      // √öltimos pagos
      const ultimos = Array.isArray(data.ultimos_pagos)
        ? data.ultimos_pagos
        : [];

      if (ultimos.length > 0) {
        const ultimosPagos = ultimos.map(p => `
          <tr class="border-t">
            <td class="px-3 py-2 text-center">${(p.monto || 0).toLocaleString()}</td>
            <td class="px-3 py-2 text-center">${f(p.fecha_ces)}</td>
            <td class="px-3 py-2 text-center">${f(p.fecha_emision)}</td>
            <td class="px-3 py-2 text-center">${f(p.fecha_pago)}</td>
            <td class="px-3 py-2 text-center">${p.plazo ?? 'N/A'}</td>
          </tr>`).join('');

        html += `
          <section>
            <h2 class="text-lg font-semibold text-blue-800 mt-8 mb-2">√öltimos Pagos</h2>
            <table class="w-full border">
              <thead class="bg-gray-100">
                <tr>
                  <th>Monto Factura</th>
                  <th>Fecha Compra</th>
                  <th>Fecha Emisi√≥n</th>
                  <th>Fecha Pago</th>
                  <th>Plazo (D√≠as)</th>
                </tr>
              </thead>
              <tbody>${ultimosPagos}</tbody>
            </table>
            <p class="mt-2">
              Promedio √∫ltimos 5 pagos:
              <strong>${data.promedio_ultimos !== undefined ? data.promedio_ultimos.toFixed(2) : "Sin datos"} d√≠as</strong>
            </p>
          </section>`;
      }

      // ==========================
      // Hist√≥rico SOLO si hay datos
      // ==========================
      if (data.cantidad_historico && data.cantidad_historico > 0) {
        html += `
          <section>
            <h2 class="text-lg font-semibold text-blue-800 mt-8 mb-2">Promedio Hist√≥rico</h2>
            <p>Pagos considerados: <strong>${data.cantidad_historico}</strong></p>
            <p>Promedio: <strong>${data.promedio_historico.toFixed(2)} d√≠as</strong></p>
            <p>Desviaci√≥n est√°ndar: <strong>${data.desviacion_estandar.toFixed(2)}</strong></p>
          </section>
        `;
      }

      // ==========================
      // Factura m√°s lenta SOLO si existe
      // ==========================
      if (data.factura_mas_lenta) {
        html += `
          <section>
            <h2 class="text-lg font-semibold text-blue-800 mt-8 mb-2">Factura m√°s lenta</h2>
            <p>Monto: ${(data.factura_mas_lenta.monto || 0).toLocaleString()}</p>
            <p>Compra: ${f(data.factura_mas_lenta.fecha_ces)}</p>
            <p>Emisi√≥n: ${f(data.factura_mas_lenta.fecha_emision)}</p>
            <p>Pago: ${f(data.factura_mas_lenta.fecha_pago)}</p>
            <p><strong>${data.factura_mas_lenta.plazo} d√≠as</strong></p>
          </section>
        `;
      } else {
        html += `
          <section>
            <h2 class="text-lg font-semibold text-blue-800 mt-8 mb-2">Factura m√°s lenta</h2>
            <p>No existen facturas registradas para este deudor.</p>
          </section>
        `;
      }

      // Morosos
      const mor = Array.isArray(data.morosos)
        ? data.morosos
        : [];

      if (mor.length > 0) {
        const morosos = mor.map(m => `
          <tr class="border-t">
            <td class="px-3 py-2 text-center">${(m.monto || 0).toLocaleString()}</td>
            <td class="px-3 py-2 text-center">${m.saldo.toLocaleString()}</td>
            <td class="px-3 py-2 text-center">${f(m.fecha_ces)}</td>
            <td class="px-3 py-2 text-center">${f(m.fecha_emision)}</td>
            <td class="px-3 py-2 text-center">${m.dias_vencido}</td>
            <td class="px-3 py-2 text-center">${m.dias_mora ?? "N/A"}</td>
          </tr>`).join('');

        html += `
          <section>
            <h2 class="text-lg font-semibold text-blue-800 mt-8 mb-2">Facturas Morosas</h2>
            <table class="w-full border border-gray-300 text-sm text-center">
              <thead class="bg-gray-100 text-blue-900 font-semibold">
                <tr>
                  <th>Monto</th>
                  <th>Saldo</th>
                  <th>Compra</th>
                  <th>Emisi√≥n</th>
                  <th>D√≠as desde emisi√≥n</th>
                  <th>D√≠as mora</th>
                </tr>
              </thead>
              <tbody>${morosos}</tbody>
            </table>
          </section>`;
      }

      div.innerHTML = html;
    }

    // ==========================================================
    // FUNCI√ìN SIMULAR ‚Äî ya incluye factor personalizado
    // ==========================================================
    function simular(plazoRecomendado, factorDias = 15) {
      const plazo = parseInt(document.getElementById('plazo').value);
      const anticipo = parseFloat(document.getElementById('anticipo').value);
      const resultado = document.getElementById('evaluacionResultado');
      const confirmarBtn = document.getElementById('confirmarBtn');

      if (isNaN(plazo) || isNaN(anticipo)) {
        alert("Por favor ingrese valores v√°lidos para plazo y anticipo.");
        return;
      }

      const puntos_anticipo = 100 - anticipo;
      const dias_extra = puntos_anticipo * factorDias;
      const total = Math.floor(plazo + dias_extra);

      simulacionAprobada = total >= plazoRecomendado;
      confirmarBtn.disabled = false;

      resultado.innerHTML = `<p>Est√°s simulando <strong>${total}</strong> d√≠as entre plazo y anticipo.</p>`;

      if (simulacionAprobada) {
        resultado.innerHTML += `
          <p class="text-green-700">‚úÖ Aprobado: el total (${total}) cubre o supera lo recomendado (${plazoRecomendado}).</p>`;
      } else {
        resultado.innerHTML += `
          <p class="text-red-600">‚ö†Ô∏è Rechazado: El total (${total}) no alcanza lo recomendado (${plazoRecomendado}). Revise con riesgo.</p>`;
      }
    }

    function confirmarSimulacion() {
      document.getElementById('plazo').disabled = true;
      document.getElementById('anticipo').disabled = true;
      document.getElementById('confirmarBtn').disabled = true;

      const resultado = document.getElementById('evaluacionResultado');
      resultado.innerHTML += `
        <button onclick="window.print()" class="mt-2 bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700">
          Guardar como PDF
        </button>`;
    }

    function formatFecha(fechaStr) {
      if (!fechaStr) return 'N/A';
      const fecha = new Date(fechaStr);
      const d = String(fecha.getDate()).padStart(2, '0');
      const m = String(fecha.getMonth() + 1).padStart(2, '0');
      const y = fecha.getFullYear();
      return `${d}-${m}-${y}`;
    }

    function limpiarResultados() {
      document.getElementById("resultados").innerHTML = "";
    }
  </script>
  
  <script type="module">
  document.addEventListener("DOMContentLoaded", async () => {

    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js");
    const { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } =
      await import("https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js");

    const firebaseConfig = {
      apiKey: "AIzaSyAUtJoJRUGDwpGhLXr-0WhGvtKlr0YwNWY",
      authDomain: "plazos-bl.firebaseapp.com",
      projectId: "plazos-bl",
      storageBucket: "plazos-bl.firebasestorage.app",
      messagingSenderId: "39828725985",
      appId: "1:39828725985:web:f414fa57db531758d397a0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authSection = document.getElementById("authSection");
    const appContent = document.getElementById("appContent");

    // --- EVENTOS ---
    loginBtn?.addEventListener("click", () => {
      signInWithPopup(auth, provider).catch((error) => {
        alert("Error al iniciar sesi√≥n: " + error.message);
      });
    });

    logoutBtn?.addEventListener("click", () => {
      signOut(auth);
    });

    // --- AUTH ---
    onAuthStateChanged(auth, (user) => {
      if (user && user.email.endsWith("@blcapital.cl")) {
        authSection.classList.add("hidden");
        appContent.classList.remove("hidden");
      } else {
        authSection.classList.remove("hidden");
        appContent.classList.add("hidden");
      }
    });

  });
  </script>

  </body>
</html>

